## Project Overview

This project is a **full-stack backend** for a chat and communication platform. The system is built using **Node.js** with **Express.js** and leverages various other technologies such as **MongoDB** for database storage, **Redis** for caching, **Cloudinary** for file uploads, **JWT** (JSON Web Token) for secure authentication, and **Socket.io** for real-time communication. The application provides user authentication, chat functionalities (both group and direct messaging), course integration, role-based access control, and file uploading capabilities.

### Technology Stack

- **Node.js & Express**: Core backend framework for building REST APIs.
- **MongoDB & Mongoose**: NoSQL database for handling persistent data.
- **Redis**: In-memory data store, used for caching chat messages and user data to optimize read operations.
- **JWT (JSON Web Token)**: Provides secure authentication with token-based authorization.
- **Socket.io**: Enables real-time bi-directional communication between clients and the server.
- **Cloudinary**: Cloud storage for handling media uploads, such as images, videos, and documents.
- **Agora**: Real-time engagement platform to generate tokens for video and voice call features.
- **Winston**: Logging system that provides tracking for errors, request flows, and exceptions.

### Core Functionalities

1. **User Authentication**: Secure login and signup using JWT tokens. Passwords are hashed using **bcrypt**.
2. **Chat Features**: Real-time chat with direct messages, course-based group messaging, and media sharing.
3. **Role-Based Access Control**: Users are assigned roles (student, lecturer, HOD), with role-specific access to certain routes.
4. **Media Uploads**: Supports uploads for images, documents, videos, and audio files, which are stored in Cloudinary.
5. **Caching**: Optimized caching with Redis for fast retrieval of frequently accessed data (e.g., user lists, chat histories).

### Folder Structure

- **`src/`**
  - **controllers/**
    - **authController.ts**: Handles user authentication, login, password reset, and email sending.
    - **chatController.ts**: Manages chat creation, fetching chats, adding/removing members, and real-time message exchange.
    - **usersController.ts**: Fetches user data and manages interactions like retrieving all users or a single user.

  - **helpers/**
    - **validation.ts**: Contains validation logic (e.g., password strength checking) using Joi schema.

  - **logs/**
    - **logger.log**: Stores log messages generated by the application for tracking errors or issues.

  - **middleware/**
    - **auth.ts**: Middleware to protect routes, ensuring users are authenticated based on JWT tokens and their roles.
    - **error.ts**: Handles error logging and returns generic error messages to the client.

  - **models/**
    - **chatModel.ts**: Defines the Chat schema, managing chat types (direct, course, group, etc.).
    - **courseModel.ts**: Defines the Course schema, including lecturer and student relationships.
    - **departmentModel.ts**: Defines Department schema for managing departments.
    - **messageModel.ts**: Handles message data, including the sender, text, chat ID, and message type.
    - **programModel.ts**: Stores information about different programs and their courses.
    - **userModel.ts**: Manages user data, including authentication and user roles (e.g., student, lecturer, HOD).

  - **routes/**
    - **auth.ts**: Contains routes for login, password reset, and user profile updates.
    - **chat.ts**: Handles chat-related routes like creating and fetching chats and managing group chats.
    - **message.ts**: Manages sending and receiving messages.
    - **uploads.ts**: Handles file uploads to Cloudinary, supporting images, videos, and audio.
    - **users.ts**: Provides routes for fetching all users or a specific user.

  - **types/**
    - **express/index.d.ts**: Extends Express request objects with additional properties like `user` and `session`.
    - **types.ts**: Type definitions for key entities such as Users, Chats, Messages, Courses, etc.

  - **index.ts**: The entry point of the backend application, setting up Express, MongoDB, Redis, and Socket.io.

  - **package.json**: Manages dependencies and scripts, with `start` being the main script for running the server using `nodemon`.

---

## Folder and File Structure Breakdown

### 1. **`src/`**

The core source directory that contains the codebase. It is organized into subfolders based on functionality such as controllers, models, routes, middleware, and utility files (helpers, logs).

---

### **1.1. Controllers Folder (`src/controllers`)**

Controllers are responsible for handling logic related to specific routes. They receive HTTP requests, process them, and return responses. Here are the controllers in detail:

#### **`authController.ts`**

Manages user authentication, including login, password reset, and session management.

- **Key imports**:
  - **`User`** from `../models/userModel`: Used to query user data from the MongoDB database.
  - **`bcrypt`**: Used to hash and verify passwords.
  - **`jwt`**: Used to generate and validate JSON Web Tokens (JWT) for user sessions.
  - **`nodemailer`**: Sends emails for password recovery.
  - **`logger`**: Logs errors or information.

- **Functions**:
  - **`login(req: Request, res: Response)`**: Handles user login. It:
    - Validates the user data using the `validateUser` function from the user model.
    - Finds the user in the database using their `indexNumber`.
    - Uses `bcrypt.compare` to check the password.
    - Generates a JWT token and stores it in cookies, with options like `httpOnly` for security.
    - Logs any errors encountered and returns relevant responses.

  - **`forgotPassword(req: Request, res: Response)`**: Manages forgotten password requests by:
    - Finding the user by `indexNumber`.
    - Generating a token with a short expiration (5 minutes) using a combination of the password and a JWT secret.
    - Sends an email with the password reset link.
    - Uses `nodemailer` to send the email via a Gmail service.

  - **`resetPasswordPost(req: Request, res: Response)`**: Handles the actual password reset:
    - Verifies the reset token.
    - Validates the new password using the `validatePassword` helper function.
    - Hashes the new password using `bcrypt` and updates the database.

#### **`chatController.ts`**

Handles the creation and management of direct messages, course-based group chats, and general chat functionality.

- **Key imports**:
  - **`Chat`** from `../models/chatModel`: To perform operations on chat data in the database.
  - **`redisClient`**: Used for caching chat data.
  - **`Message`**: Handles messages related to chats.

- **Functions**:
  - **`createChat(req: Request, res: Response)`**: Handles direct chat creation.
    - Checks if both users share at least one course.
    - Creates a new chat document with the two users as members and stores the course details.

  - **`getChats(req: Request, res: Response)`**: Retrieves chats for a user. It checks Redis for cached data, otherwise, it fetches from MongoDB and stores it in Redis for faster future access.

  - **`addMessage(req: Request, res: Response)`**: Adds a new message to a chat. It:
    - Validates the chat ID.
    - Checks the type of chat (direct, group, course) and stores the message.
    - Caches the new message in Redis.

  - **`createCourseChat(req: Request, res: Response)`**: Creates course-based group chats.
    - Fetches all courses of the current user.
    - Finds or creates a chat for each course and adds all enrolled users to the chat.

#### **`usersController.ts`**

Manages fetching and returning user data.

- **Key imports**:
  - **`User`** from `../models/userModel`: For querying users.
  - **`redisClient`**: Caching of users to speed up fetches.
  - **`logger`**: Logs any issues.

- **Functions**:
  - **`getUsers(req: Request, res: Response)`**: Fetches all users except the current one, selecting fields like first name, last name, courses, and profile picture.
  - **`getUser(req: Request, res: Response)`**: Fetches a single user by their `recipientId` and returns the user data.

---

### **1.2. Helpers Folder (`src/helpers`)**

This folder contains utility functions used across multiple parts of the application.

#### **`validation.ts`**

Defines validation functions to ensure user data adheres to expected patterns.

- **`validatePassword(data: ValidatePasswordProps)`**:
  - Uses **Joi** schema to validate passwords based on criteria like:
    - Minimum length of 8 characters.
    - At least one uppercase letter, one lowercase letter, one number, and one special character.
    - Returns validation results to the controller.

---

### **1.3. Middleware Folder (`src/middleware`)**

Middleware functions provide reusable logic for handling requests before they reach the controller. They include authentication checks and error handling.

#### **`auth.ts`**

A middleware function that checks whether the user is authenticated by validating the JWT token.

- **Key imports**:
  - **`jwt`**: To decode and validate tokens.
  
- **Function**:
  - **`auth(roles: string[])`**: A higher-order middleware function that:
    - Verifies the token from the cookies or `Authorization` header.
    - Decodes the token and checks if the user's role matches the required role for that route.
    - Calls the `next()` function if valid, otherwise returns an unauthorized error.

#### **`error.ts`**

A global error-handling middleware.

- **Key imports**:
  - **`logger`**: Logs the error message.

- **Function**:
  - **`error(err: Error, req: Request, res: Response, next: NextFunction)`**: Catches any errors that occur in the application, logs them, and returns a 500 status code.

---

### **1.4. Models Folder (`src/models`)**

The **models** define the data structure for the application, including users, chats, and messages. These models interact with the MongoDB database using **Mongoose**.

#### **`userModel.ts`**

Defines the user schema and model for MongoDB, along with the user authentication methods.

- **Schema Fields**:
  - **`firstName`** and **`lastName`**: Strings representing the user’s full name.
  - **`email`**: Stores user’s email address, which is unique.
  - **`password`**: Hashed password stored securely.
  - **`indexNumber`**: Unique identifier for each user.
  - **`role`**: Defines the role of the user (`student`, `lecturer`, `HOD`).
  - **`courses`**: List of course objects the user is enrolled in.

- **Methods**:
  - **`generateAuthToken()`**: Generates a JWT token for the user based on their details. This token is used for subsequent authenticated requests.

#### **`chatModel.ts`**

Manages the structure of chats (direct, group, course-based chats).

- **Schema Fields**:
  - **`members`**: Array of user IDs participating in the chat.
  - **`type`**: Chat type (direct, course, group, department).
  - **`courses`**: If it’s a course chat, this field stores the courses associated with it.

#### **`messageModel.ts`**

Defines the structure for messages within chats.

- **Schema Fields**:
  - **`sender`**: The user ID of the sender.
  - **`text`**: The actual message content.
  - **`chatId`**: The chat this message belongs to.
  - **`createdAt`**: Timestamp of when the message was sent.
  - **`type`**: Defines the type of message (e.g., text, image, video).

---

### **1.5. Routes Folder (`src/routes`)**

The **routes** define the available HTTP endpoints that the application can receive. Each file maps to a particular feature or set of features.

#### **`auth.ts`**

Defines routes for authentication, including login, password reset, and profile update operations.

- **`POST /login`**: Handles user login.
- **`POST /forgot-password`**: Sends password reset email.
- **`GET /reset-password/:id/:token`**: Verifies password reset token.
- **`POST /reset-password/:id/:token`**: Resets the user’s password.

#### **`chat.ts`**

Defines routes related to chats and messages.

- **`POST /create-direct-chat/:userId`**: Creates a direct chat between two users.
- **`GET /:chatId/messages`**: Retrieves all messages in a chat.
- **`POST /group-chat/add-member`**: Adds a member to a group chat.
- **`PUT /group-chat/remove-member`**: Removes a member from a group chat.

#### **`uploads.ts`**

Handles file uploads to **Cloudinary**.

- **`POST /`**: Uploads a file (image, video, or document) using Multer for file handling and Cloudinary for storage. Supports in-memory storage of files before uploading.

---

### **1.6. Types Folder (`src/types`)**

Contains TypeScript types used throughout the application for type-checking and ensuring data consistency.

- **`express/index.d.ts`**: Extends the Express request object to include custom properties such as the `user` field, which holds decoded JWT token data.
  
- **`types.ts`**: Defines types for key entities like `User`, `Chat`, `Message`, `Department`, and `Program`:
  - **`IUser`**: Represents a user, including their personal details, courses, and authentication methods.
  - **`IChat`**: Represents a chat, including members, type, and associated courses.
  - **`IMessage`**: Defines the structure of a chat message.
  - **`ICourse`**: Stores information about a course, including lecturers and students.

---

### **1.7. Configurations & Startup Files**

#### **`logger.ts`**

Handles logging using **Winston**. Logs can be stored both in the console and in a file or MongoDB.

#### **`cloudinary.ts`**

Configures **Cloudinary** for media file storage, using environment variables for authentication.

#### **`routes.ts`**

Sets up the main routes for the application, including auth, chats, users, and file uploads.

#### **`index.ts`**

The main entry point for the application:

- Sets up the Express app.
- Connects to MongoDB and Redis.
- Initializes **Socket.io** for real-time communication.
- Starts the server on a specified port.

---

## Key Components

### Controllers

- **`authController.ts`**
  - Manages authentication, including login and password reset via email.
  - Uses **JWT** for generating and validating authentication tokens.
  - Employs **bcrypt** to securely hash and validate passwords.
  
- **`chatController.ts`**
  - Handles the creation of direct and group chats, ensuring users share courses for direct messaging.
  - Uses Redis to cache chat and message data for faster access.
  - Allows adding and removing members from group chats, editing group details, and sending messages.
  
- **`usersController.ts`**
  - Fetches user information based on user roles.
  - Uses Redis to cache user data and improve performance.

### Middleware

- **`auth.ts`**
  - Verifies JWT tokens to protect routes.
  - Checks if the user's role matches the required permissions for certain actions (e.g., only lecturers can access specific routes).

- **`error.ts`**
  - Centralized error-handling middleware that logs errors and returns a generic error message to the client.

### Models

- **`userModel.ts`**
  - Manages user data with fields like `firstName`, `lastName`, `email`, `indexNumber`, and `role`.
  - Uses **JWT** for token-based authentication and generates tokens using the `generateAuthToken()` method.

- **`chatModel.ts`**
  - Defines the structure for storing chat data, including members, type (direct, group, etc.), and related courses.

- **`messageModel.ts`**
  - Stores messages with fields like sender, text, chatId, and type (text, image, video, etc.).

### Helpers

- **`validation.ts`**
  - Provides a validation function to ensure passwords meet certain criteria (e.g., length, special characters).

### Routes

- **`auth.ts`**
  - Manages user authentication, including login, password reset, and profile updates.
  - Supports file uploads for user profile pictures using **Multer** and **Cloudinary**.

- **`chat.ts`**
  - Defines routes for managing chats (creating, fetching, updating) and supports adding/removing members from group chats.

- **`uploads.ts`**
  - Uploads files to Cloudinary, supporting different media types like images, videos, and audio.

### Real-Time Communication

- **Socket.io**: Manages real-time chat and notification functionalities.
  - Users can join rooms based on their courses or group chats.
  - Real-time messages are sent and received using Socket.io, which ensures instant communication between users.

---

## Database Connections

- **MongoDB**: The primary database for storing user, chat, and message data. Connection is managed using Mongoose.
- **Redis**: Used for caching chat and user data, improving performance by reducing the load on MongoDB.

### Logger

- **`logger.ts`**
  - Uses **Winston** to log information to both the console and MongoDB.
  - Logs errors, requests, and any exceptions, making it easier to track issues in the application.

### Token Generation

- **Agora Token**: The app generates real-time communication tokens for voice and video calls using the Agora SDK.

---

Here’s the updated setup guide with your specific environment variables included. This version outlines how to configure your environment variables and run the backend server for the chat and communication platform.

---

## **Setup and Configuration**

### **Environment Setup**

To run the chat and communication platform on your local machine, follow the steps outlined below. This guide walks through setting up MongoDB, configuring environment variables, installing dependencies, and starting the server.

### **1. Prerequisites**

Make sure you have the following software installed:

1. **Node.js**: Download and install the latest LTS version from [Node.js](https://nodejs.org).
2. **npm**: This comes with Node.js. Verify the installation with:

   ```bash
   npm -v
   ```

3. **MongoDB**: Install MongoDB locally by following instructions on [MongoDB's official site](https://www.mongodb.com/try/download/community). Ensure MongoDB is running.
4. **MongoDB Compass**: (Optional) Install MongoDB Compass for managing MongoDB databases visually. Download it from [here](https://www.mongodb.com/try/download/compass).
5. **Redis**: Redis can be installed locally or you can use a cloud-based Redis service. You have a Redis URL for cloud access.

### **2. Setting Up MongoDB**

After installing MongoDB, follow these steps to ensure the database is set up:

1. **Start MongoDB**:
   On most systems, MongoDB will start automatically. If not, run:

   ```bash
   mongod
   ```

2. **Create Database and Collections**:
   - Connect to your local MongoDB instance using **MongoDB Compass** or the MongoDB shell.
   - Create a new database named `chat-forum`.
   - Set up collections for users, chats, messages, and other required data.
   - If you have JSON data files, you can import them using the MongoDB shell:

     ```bash
     mongoimport --db chat-forum --collection <collection-name> --file <path-to-json-file> --jsonArray
     ```

### **3. Configure Environment Variables**

Create a `.env` file in the root of your project directory and add the following content:

```bash
MONGODB_URI=mongodb://127.0.0.1/chat-forum
JWTPrivateKey=secret
APP_Password=oyhc yxmg psuy dpfm
EMAIL=marvin.asamoah.123@gmail.com
FRONTEND_URL=http://localhost:5173
PORT=5000
CLOUD_NAME=droeaaqpq
API_KEY=332927511219839
API_SECRET=DKya89qUevN69lvkwNzE00qrA0o
APP_ID=d90459e3074b40a9848bd6d5a10e6631
APP_CERTIFICATE=6b887c3b2d524d1096b12a39f9f33136
REDIS_KEY=bSHI1lP5nDDh0xX3taY4hDU9MoNmWbeW
REDIS_URL=redis-12024.c11.us-east-1-2.ec2.redns.redis-cloud.com
REDIS_PORT=12024
```

- **MONGODB_URI**: Points to your local MongoDB instance and the `chat-forum` database.
- **JWTPrivateKey**: Used for signing JWT tokens.
- **APP_Password & EMAIL**: Used for email services, such as sending password recovery emails.
- **FRONTEND_URL**: Points to your frontend application, presumably running on port 5173 locally.
- **PORT**: Defines the port your backend server will run on (5000 in this case).
- **Cloudinary Config**: The `CLOUD_NAME`, `API_KEY`, and `API_SECRET` are for uploading media files to Cloudinary.
- **Agora Config**: `APP_ID` and `APP_CERTIFICATE` are used for generating tokens for Agora services (e.g., video and audio).
- **Redis Config**: `REDIS_KEY`, `REDIS_URL`, and `REDIS_PORT` are for connecting to your Redis instance in the cloud for caching purposes.

### **4. Install Dependencies**

After setting up your environment variables, install the necessary dependencies by running:

```bash
npm install
```

This will install all required dependencies, including Express, Mongoose, Socket.io, Redis, Cloudinary, JWT, and other necessary packages.

### **5. Start the Server**

With MongoDB running and your `.env` file configured, start the server using:

```bash
npm start
```

You should see a message in your terminal indicating that the server is running on the specified port (e.g., `Server running on port 5000`).

### **6. Testing the Application**

Use **Postman** or **cURL** to test the various API endpoints, such as:

- **Login**: `POST /login`
- **Create Chat**: `POST /create-direct-chat/:userId`

You can also access your MongoDB data using **MongoDB Compass** or the MongoDB shell to verify that your data is being saved and updated correctly.

### **7. Redis Configuration**

Since you're using a cloud Redis instance, ensure your Redis service is accessible. You can check the connection by running the Redis CLI:

```bash
redis-cli -h redis-12024.c11.us-east-1-2.ec2.redns.redis-cloud.com -p 12024 -a <your-redis-password>
```

If Redis responds with `PONG`, it is working correctly.

---

## **Running the Application**

After following the setup steps, your application should be live and accessible on `http://localhost:5000`. The backend will handle requests such as user authentication, chat messaging, file uploads, and more. Ensure you have the frontend configured to interact with this backend if applicable.

- **Local URL**:

  ```
  http://localhost:5000
  ```

You can now start interacting with the API through the frontend or via testing tools like Postman.

---

### **Deployment**

The backend is deployed on **Heroku**. You can access the deployed API at the following URL:

**Deployed URL**: [https://chat-forum-api-db3bf0ece27b.herokuapp.com](https://chat-forum-api-db3bf0ece27b.herokuapp.com)

---
